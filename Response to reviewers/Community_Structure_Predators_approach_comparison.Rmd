---
title: "Community Structure - Herbivore and Detritivores"
author: "Rodolfo Pelinson"
date: "27/12/2022"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r echo = TRUE, message=FALSE, warning=FALSE}
library(vegan)
library(gllvm)
package_version("gllvm")
packageVersion("gllvm")
attributes(citation("gllvm"))
```

```{r include = FALSE}
setwd("C:/Users/rodol/OneDrive/Trabalho/Papers/Analysis/IsolationAgrochemicals")
source("Auxiliary scripts/Loading_data.R")
source("Auxiliary scripts/Ordination_plots.R")

```


Before anything, here are three functions that will automate most of the model selection procedures that we will be doing. The script would be gigantic without them.
```{r}
setwd("C:/Users/rodol/OneDrive/Trabalho/Papers/Analysis/IsolationAgrochemicals")
source("Auxiliary scripts/gllvm_AICc_tab.R")
source("Auxiliary scripts/run_multiple_lv.R")
source("Auxiliary scripts/run_multiple_gllvm.R")
source("Auxiliary scripts/get_scaled_lvs.R")
```


# Herbivores and Detritivores

Lets make tables with only herbivore and insectivores. Note that here we excludes species that occur in less than 4 samples in each survey because are less informative to community patterns and complicate parameter estimation.

```{r, warning=FALSE}
com_pred_SS1 <- com_SS1[,Trait_SS1$trophic == "predator"]
com_pred_SS2 <- com_SS2[,Trait_SS2$trophic == "predator"]
com_pred_SS3 <- com_SS3[,Trait_SS3$trophic == "predator"]
com_pred_SS4 <- com_SS4[,Trait_SS4$trophic == "predator"]

sum_com_pred_SS2 <- sum_com_SS2[,Trait_SS2_sum$trophic == "predator"]
sum_com_pred_SS3 <- sum_com_SS3[,Trait_SS3_sum$trophic == "predator"]
sum_com_pred_SS4 <- sum_com_SS4[,Trait_SS4_sum$trophic == "predator"]
```


## First Survey (20 day)

We always used a negative binomial distribution to model species abundances.

```{r}
SS1_predictors <- data.frame(treatments = treatments_SS1,
                             isolation = isolation_SS1)
```



Number of latent variables:
```{r, warning=FALSE}
n_latent_tab_SS1 <- run_multiple_lv(formula = ~ treatments * isolation,
                                    num.lv = c(0,1,2,3),
                                    y = com_pred_SS1, X = SS1_predictors,
                                    family = "negative.binomial",
                                    method = "VA",
                                    n.init = 10, seed = 1:10, starting.val = 0)

n_latent_tab_SS1$AICc_tab

```
It looks that zero latent variables is the way to go. This will repeat itself for the next cases.


Model selection of effects:
```{r, warning=FALSE}
model_pred_selection_SS1 <- run_multiple_gllvm(formulas = list(~ treatments,
                                                                    ~ isolation,
                                                                    ~ treatments + isolation,
                                                                    ~ treatments * isolation),
                                                    names = c("Treatments",
                                                              "Isolation",
                                                              "Isolation + Treatments",
                                                              "Isolation * Treatments"),
                                                    no_effect = TRUE,
                                                    num.lv = 0,
                                                    X = SS1_predictors,
                                                    y = com_pred_SS1,
                                                    family = "negative.binomial",
                                                    method = "VA",
                                                    n.init = 10, seed = 1:10, starting.val = 0)

model_pred_selection_SS1$AICc_tab
```
No effects according to model selection

From a frequentist perspective, doing LRT.
```{r}
anova(model_pred_selection_SS1$models$Treatments, model_pred_selection_SS1$models$`Isolation + Treatments`)
anova(model_pred_selection_SS1$models$Isolation, model_pred_selection_SS1$models$`Isolation + Treatments`)
anova(model_pred_selection_SS1$models$`Isolation + Treatments`, model_pred_selection_SS1$models$`Isolation * Treatments`)
```
No effects according to LRT as well.


## Second Survey (40 day)

```{r, warning=FALSE}
SS2_predictors <- data.frame(ID = ID_SS2_3_4,
                             treatments = treatments_SS2_3_4,
                             isolation = isolation_SS2_3_4)
```


Number of latent variables:
```{r, cache = TRUE, warning=FALSE}
n_latent_tab_SS2 <- run_multiple_lv(num.lv = c(0,1,2,3),
                                    formula = ~ treatments * isolation,
                                    y = com_pred_SS2, X = SS2_predictors,
                                    row.eff = ~ (1|ID),
                                    family = "negative.binomial",
                                    method = "VA",
                                    n.init = 10, seed = 1:10, control = list(optim.method = "L-BFGS-B"))


n_latent_tab_SS2$AICc_tab

```
It looks that zero latent variables is the way to go.


Model selection of effects:
```{r, cache = TRUE, warning=FALSE}
model_pred_selection_SS2 <- run_multiple_gllvm(formulas = list(~ treatments,
                                                                    ~ isolation,
                                                                    ~ treatments + isolation,
                                                                    ~ treatments * isolation),
                                                    names = c("Treatments",
                                                              "Isolation",
                                                              "Isolation + Treatments",
                                                              "Isolation * Treatments"),
                                                    no_effect = TRUE,
                                                    row.eff = ~ (1|ID),
                                                    X_row = data.frame(ID = ID_SS2_3_4),
                                                    num.lv = 0,
                                                    X = SS2_predictors,
                                                    y = com_pred_SS2,
                                                    family = "negative.binomial",
                                                    method = "VA",
                                                    n.init = 10, seed = 1:10, control = list(optim.method = "L-BFGS-B"))

model_pred_selection_SS2$AICc_tab

```
Only effects of treatments.

From a frequentist perspective:
```{r}
#Isolation
anova(model_pred_selection_SS2$models$Treatments, model_pred_selection_SS2$models$`Isolation + Treatments`)

#Treatments
anova(model_pred_selection_SS2$models$Isolation, model_pred_selection_SS2$models$`Isolation + Treatments`)

#Interaction
anova(model_pred_selection_SS2$models$`Isolation + Treatments`, model_pred_selection_SS2$models$`Isolation * Treatments`)
```
Also only effects of treatments.

#### Now, lets repeat this analysis pooling all samples from the same pond together.

```{r, warning=FALSE}
sum_SS2_predictors <- data.frame(ID = ID_SS1,
                             treatments = treatments_SS1,
                             isolation = isolation_SS1)
```


Number of latent variables:
```{r, cache = TRUE, warning=FALSE}
sum_n_latent_tab_SS2 <- run_multiple_lv(num.lv = c(0,1,2,3),
                                    formula = ~ treatments * isolation,
                                    y = sum_com_pred_SS2, X = sum_SS2_predictors,
                                    family = "negative.binomial",
                                    method = "VA",
                                    n.init = 10, seed = 1:10)


sum_n_latent_tab_SS2$AICc_tab

```
It looks that zero latent variables is the way to go.


Model selection of effects:
```{r, cache = TRUE, warning=FALSE}
sum_model_pred_selection_SS2 <- run_multiple_gllvm(formulas = list(~ treatments,
                                                                    ~ isolation,
                                                                    ~ treatments + isolation,
                                                                    ~ treatments * isolation),
                                                    names = c("Treatments",
                                                              "Isolation",
                                                              "Isolation + Treatments",
                                                              "Isolation * Treatments"),
                                                    no_effect = TRUE,
                                                    num.lv = 0,
                                                    X = sum_SS2_predictors,
                                                    y = sum_com_pred_SS2,
                                                    family = "negative.binomial",
                                                    method = "VA",
                                                    n.init = 10, seed = 11:20)

sum_model_pred_selection_SS2$AICc_tab
```
Only effects of treatments.


From a frequentist perspective:
```{r}
#Isolation
anova(sum_model_pred_selection_SS2$models$Treatments, sum_model_pred_selection_SS2$models$`Isolation + Treatments`)

#Treatments
anova(sum_model_pred_selection_SS2$models$Isolation, sum_model_pred_selection_SS2$models$`Isolation + Treatments`)

#Interaction
anova(sum_model_pred_selection_SS2$models$`Isolation + Treatments`, sum_model_pred_selection_SS2$models$`Isolation * Treatments`)
```
Also only effects of treatments 





## Third Survey (80 day)

```{r, warning=FALSE}
SS3_predictors <- data.frame(ID = ID_SS2_3_4,
                             treatments = treatments_SS2_3_4,
                             isolation = isolation_SS2_3_4)
```


Number of latent variables:
```{r, cache = TRUE, warning=FALSE}
n_latent_tab_SS3 <- run_multiple_lv(num.lv = c(0,1,2,3),
                                    formula = ~ treatments * isolation,
                                    y = com_pred_SS3, X = SS3_predictors,
                                    row.eff = ~ (1|ID),
                                    family = "negative.binomial",
                                    method = "VA",
                                    n.init = 10, seed = 1:10)


n_latent_tab_SS3$AICc_tab

```
It looks that zero latent variables is the way to go.


Model selection of effects:
```{r, cache = TRUE, warning=FALSE}
model_pred_selection_SS3 <- run_multiple_gllvm(formulas = list(~ treatments,
                                                                    ~ isolation,
                                                                    ~ treatments + isolation,
                                                                    ~ treatments * isolation),
                                                    names = c("Treatments",
                                                              "Isolation",
                                                              "Isolation + Treatments",
                                                              "Isolation * Treatments"),
                                                    no_effect = TRUE,
                                                    row.eff = ~ (1|ID),
                                                    X_row = data.frame(ID = ID_SS2_3_4),
                                                    num.lv = 0,
                                                    X = SS3_predictors,
                                                    y = com_pred_SS3,
                                                    family = "negative.binomial",
                                                    method = "VA",
                                                    n.init = 10, seed = 1:10)

model_pred_selection_SS3$AICc_tab

```
It seems like there is evidence for additive effects of agrochemicals and isolation here

From a frequentist perspective:
```{r}
#Isolation
anova(model_pred_selection_SS3$models$Treatments, model_pred_selection_SS3$models$`Isolation + Treatments`)

#Treatments
anova(model_pred_selection_SS3$models$Isolation, model_pred_selection_SS3$models$`Isolation + Treatments`)

#Interaction
anova(model_pred_selection_SS3$models$`Isolation + Treatments`, model_pred_selection_SS3$models$`Isolation * Treatments`)
```
P-values for LRT go to the same direction


#### Now, lets repeat this analysis pooling all samples from the same pond together.
```{r, warning=FALSE}
sum_SS3_predictors <- data.frame(ID = ID_SS1,
                             treatments = treatments_SS1,
                             isolation = isolation_SS1)
```


Number of latent variables:
```{r, cache = TRUE, warning=FALSE}
sum_n_latent_tab_SS3 <- run_multiple_lv(num.lv = c(0,1,2,3),
                                    formula = ~ treatments * isolation,
                                    y = sum_com_pred_SS3, X = sum_SS3_predictors,
                                    family = "negative.binomial",
                                    method = "VA",
                                    n.init = 10, seed = 1:10)


sum_n_latent_tab_SS3$AICc_tab

```
It looks that zero latent variables is the way to go.


Model selection of effects:
```{r, cache = TRUE, warning=FALSE}
sum_model_pred_selection_SS3 <- run_multiple_gllvm(formulas = list(~ treatments,
                                                                    ~ isolation,
                                                                    ~ treatments + isolation,
                                                                    ~ treatments * isolation),
                                                    names = c("Treatments",
                                                              "Isolation",
                                                              "Isolation + Treatments",
                                                              "Isolation * Treatments"),
                                                    no_effect = TRUE,
                                                    num.lv = 0,
                                                    X = sum_SS3_predictors,
                                                    y = sum_com_pred_SS3,
                                                    family = "negative.binomial",
                                                    method = "VA",
                                                    n.init = 10, seed = 1:10)

sum_model_pred_selection_SS3$AICc_tab
```
Now we only have evidence for the effect of agrochemical treatments.


From a frequentist perspective:
```{r}
#Isolation
anova(sum_model_pred_selection_SS3$models$Treatments, sum_model_pred_selection_SS3$models$`Isolation + Treatments`)

#Treatments
anova(sum_model_pred_selection_SS3$models$Isolation, sum_model_pred_selection_SS3$models$`Isolation + Treatments`)

#Interaction
anova(sum_model_pred_selection_SS3$models$`Isolation + Treatments`, sum_model_pred_selection_SS3$models$`Isolation * Treatments`)
```
LRT, however says we aditive effects AND interactive effects.


#### Conclusion
For mixed models both LRT and model selection agree that we have additive effects of isolation and agrochemicals. However, when we pool samples from the same pond together only agrochemicals are important for model selection and interactive effects are important doing LRT. The mixed model approach seems to be more reliable. 





## Fourth Survey (160 day)

```{r, warning=FALSE}
SS4_predictors <- data.frame(ID = ID_SS2_3_4,
                             treatments = treatments_SS2_3_4,
                             isolation = isolation_SS2_3_4)
```


Number of latent variables:
```{r, cache = TRUE, warning=FALSE}
n_latent_tab_SS4 <- run_multiple_lv(num.lv = c(0,1,2,3),
                                    formula = ~ treatments * isolation,
                                    y = com_pred_SS4, X = SS4_predictors,
                                    row.eff = ~ (1|ID),
                                    family = "negative.binomial",
                                    method = "VA",
                                    n.init = 10, seed = 1:10)


n_latent_tab_SS4$AICc_tab

```
It looks that zero latent variables is the way to go.


Model selection of effects:
```{r, cache = TRUE, warning=FALSE}
model_pred_selection_SS4 <- run_multiple_gllvm(formulas = list(~ treatments,
                                                                    ~ isolation,
                                                                    ~ treatments + isolation,
                                                                    ~ treatments * isolation),
                                                    names = c("Treatments",
                                                              "Isolation",
                                                              "Isolation + Treatments",
                                                              "Isolation * Treatments"),
                                                    no_effect = TRUE,
                                                    row.eff = ~ (1|ID),
                                                    X_row = data.frame(ID = ID_SS2_3_4),
                                                    num.lv = 0,
                                                    X = SS4_predictors,
                                                    y = com_pred_SS4,
                                                    family = "negative.binomial",
                                                    method = "VA",
                                                    n.init = 10, seed = 1:10)

model_pred_selection_SS4$AICc_tab

```
Evidence for additive effects of agrochemicals and isolation.


From a frequentist perspective:
```{r}
#Isolation
anova(model_pred_selection_SS4$models$Treatments, model_pred_selection_SS4$models$`Isolation + Treatments`)

#Treatments
anova(model_pred_selection_SS4$models$Isolation, model_pred_selection_SS4$models$`Isolation + Treatments`)

#Interaction
anova(model_pred_selection_SS4$models$`Isolation + Treatments`, model_pred_selection_SS4$models$`Isolation * Treatments`)
```
Evidence for additive effects as well.


#### Now, lets repeat this analysis pooling all samples from the same pond together.
```{r, warning=FALSE}
sum_SS4_predictors <- data.frame(ID = ID_SS1,
                             treatments = treatments_SS1,
                             isolation = isolation_SS1)
```


Number of latent variables:
```{r, cache = TRUE, warning=FALSE}
sum_n_latent_tab_SS4 <- run_multiple_lv(num.lv = c(0,1,2,3),
                                    formula = ~ treatments * isolation,
                                    y = sum_com_pred_SS4, X = sum_SS4_predictors,
                                    family = "negative.binomial",
                                    method = "VA",
                                    n.init = 10, seed = 1:10)


sum_n_latent_tab_SS4$AICc_tab

```
It looks that zero latent variables is the way to go.


Model selection of effects:
```{r, cache = TRUE, warning=FALSE}
sum_model_pred_selection_SS4 <- run_multiple_gllvm(formulas = list(~ treatments,
                                                                    ~ isolation,
                                                                    ~ treatments + isolation,
                                                                    ~ treatments * isolation),
                                                    names = c("Treatments",
                                                              "Isolation",
                                                              "Isolation + Treatments",
                                                              "Isolation * Treatments"),
                                                    no_effect = TRUE,
                                                    num.lv = 0,
                                                    row.eff = FALSE,
                                                    X = sum_SS4_predictors,
                                                    y = sum_com_pred_SS4,
                                                    family = "negative.binomial",
                                                    method = "VA",
                                                    n.init = 10, seed = 1:10)

sum_model_pred_selection_SS4$AICc_tab

```
No effects here.

From a frequentist perspective:
```{r}
#Isolation
anova(sum_model_pred_selection_SS4$models$Treatments, sum_model_pred_selection_SS4$models$`Isolation + Treatments`)

#Treatments
anova(sum_model_pred_selection_SS4$models$Isolation, sum_model_pred_selection_SS4$models$`Isolation + Treatments`)

#Interaction
anova(sum_model_pred_selection_SS4$models$`Isolation + Treatments`, sum_model_pred_selection_SS4$models$`Isolation * Treatments`)
```
LRT, however, seems to show evidence for additive effects.


#### Conclusion
Here only model selection for the non-mixed model seems say that there is no effects of treatments. Again, the model selection with the mixed model approach seems to be more reliable.

## Gerneral conclusion
Generally, model selection with samples pooled together seems to be to conservative, whereas LRTs seems to be the oposit. Both LRT and model selection through AICc have pros and cons.

 - Likelihood Ratio Tests generically don't penalize for the number of parameters in the model and are likely to consider that more parameters provide a better fit to the models. Also,  they are not indicated for gllvms because of the large difference in degrees of freedom.

 - Model Selection through AICc have a problem of not accurately estimate degrees of freedom in mixed models and heavely penalize models with too many parameters. However this seems to not be a problem with the mixed model approach.
 
Finally, given these results and the ones for herbivores and detritivores, we chose to interpret the results for model selection the mixed models.


